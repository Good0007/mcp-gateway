# MCP Agent æ¶æ„è®¾è®¡

> æŠ€æœ¯æ–‡æ¡£ - é¢å‘å¼€å‘è€…å’Œæ¶æ„å¸ˆ

## ğŸ“ é¡¹ç›®æ¦‚å†µ

MCP Agent æ˜¯åŸºäº Bun + TypeScript å¼€å‘çš„ Monorepo é¡¹ç›®ï¼Œé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ã€‚

### æŠ€æœ¯æ ˆ

- **è¿è¡Œæ—¶**: Bun 1.3+ï¼ˆå¼€å‘æ„å»ºï¼‰ã€Node.js 24+ LTSï¼ˆç”Ÿäº§è¿è¡Œï¼‰
- **è¯­è¨€**: TypeScript 5.x
- **å‰ç«¯**: React 18 + Vite + TailwindCSS
- **åç«¯**: Honoï¼ˆè½»é‡çº§ Web æ¡†æ¶ï¼‰
- **åŒ…ç®¡ç†**: Bun Workspacesï¼ˆMonorepoï¼‰
- **å®¹å™¨åŒ–**: Docker + Docker Compose

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·ç•Œé¢å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Web UI (React) â”‚  â”‚  CLI Tool (Bun)  â”‚  â”‚ API Clients   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                    â”‚
           â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API æœåŠ¡å±‚ (Hono)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /api/services  /api/config  /api/auth  /api/environment  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ ¸å¿ƒä¸šåŠ¡å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tool         â”‚  â”‚ Service       â”‚  â”‚ XiaozhiConnection  â”‚  â”‚
â”‚  â”‚ Aggregator   â”‚  â”‚ Registry      â”‚  â”‚ (WebSocket Client) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                   â”‚
          â–¼                  â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é€‚é…å™¨å±‚ (Adapters)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   stdio    â”‚  â”‚ embedded   â”‚  â”‚    sse     â”‚  â”‚   http   â”‚ â”‚
â”‚  â”‚  Adapter   â”‚  â”‚  Adapter   â”‚  â”‚  Adapter   â”‚  â”‚ Adapter  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚              â”‚
         â–¼               â–¼               â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MCP æœåŠ¡å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚FileSystemâ”‚  â”‚ Memory   â”‚  â”‚  GitHub  â”‚  â”‚  Custom  â”‚  ...  â”‚
â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Monorepo ç»“æ„

```
mcp-agent/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/              # å…±äº«ç±»å‹å’Œå·¥å…·
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â””â”€â”€ types/       # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                # MCP æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ adapters/    # æœåŠ¡é€‚é…å™¨
â”‚   â”‚       â”œâ”€â”€ core/        # æ ¸å¿ƒç±»ï¼ˆAgent, Registryï¼‰
â”‚   â”‚       â”œâ”€â”€ config/      # é…ç½®ç®¡ç†
â”‚   â”‚       â””â”€â”€ utils/       # å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ server/              # API æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ routes/      # API è·¯ç”±
â”‚   â”‚       â”œâ”€â”€ middleware/  # ä¸­é—´ä»¶ï¼ˆè®¤è¯ç­‰ï¼‰
â”‚   â”‚       â””â”€â”€ public/      # é™æ€æ–‡ä»¶ï¼ˆå‰ç«¯æ„å»ºäº§ç‰©ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ web/                 # Web å‰ç«¯
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ pages/       # é¡µé¢ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ components/  # UI ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ api/         # API å®¢æˆ·ç«¯
â”‚   â”‚       â””â”€â”€ hooks/       # React Hooks
â”‚   â”‚
â”‚   â””â”€â”€ cli/                 # å‘½ä»¤è¡Œå·¥å…·
â”‚       â””â”€â”€ src/
â”‚           â””â”€â”€ cli.ts       # CLI å…¥å£
â”‚
â”œâ”€â”€ config/                  # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ web-config.json      # æœåŠ¡é…ç½®
â”‚   â””â”€â”€ runtime-state.json   # è¿è¡Œæ—¶çŠ¶æ€
â”‚
â””â”€â”€ docs/                    # æ–‡æ¡£
```

## ğŸ”Œ é€‚é…å™¨ç³»ç»Ÿ

### é€‚é…å™¨æ¥å£

æ‰€æœ‰é€‚é…å™¨éƒ½å®ç°ç»Ÿä¸€çš„ `BaseAdapter` æ¥å£ï¼š

```typescript
interface BaseAdapter {
  id: string;
  name: string;
  enabled: boolean;
  
  // ç”Ÿå‘½å‘¨æœŸ
  initialize(): Promise<void>;
  start(): Promise<void>;
  stop(): Promise<void>;
  
  // MCP åè®®
  listTools(): Promise<Tool[]>;
  callTool(name: string, args: any): Promise<ToolResult>;
  
  // äº‹ä»¶
  on(event: string, handler: Function): void;
}
```

### æ”¯æŒçš„é€‚é…å™¨ç±»å‹

| ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ | å®ç°ç±» |
|------|------|----------|--------|
| **stdio** | å­è¿›ç¨‹é€šä¿¡ | npx/uvx å‘½ä»¤ | `StdioAdapter` |
| **embedded** | è¿›ç¨‹å†…æœåŠ¡ | æœ¬åœ° TS æ¨¡å— | `EmbeddedAdapter` |
| **sse** | Server-Sent Events | æµå¼æœåŠ¡ | `SSEAdapter` |
| **http** | REST API | HTTP æœåŠ¡ | `HTTPAdapter` |

## ğŸ”„ æ•°æ®æµ

### 1. æœåŠ¡æ³¨å†Œä¸å¯åŠ¨

```
ç”¨æˆ·é…ç½® â†’ Config Loader â†’ Service Registry â†’ Adapter Factory â†’ Service Start
```

### 2. å·¥å…·è°ƒç”¨æµç¨‹

```
AI å®¢æˆ·ç«¯è¯·æ±‚
    â†“
API Route (/api/tools/call)
    â†“
Tool Aggregator (è·¯ç”±åˆ°å¯¹åº”æœåŠ¡)
    â†“
Service Adapter (æ‰§è¡Œå·¥å…·)
    â†“
MCP Service (å®é™…æ‰§è¡Œ)
    â†“
è¿”å›ç»“æœ
```

### 3. å°æ™º AI é›†æˆ

```
MCP Agent (WebSocket Client)
    â†“
wss://api.xiaozhi.me/mcp/
    â†“
å°æ™º AI æœåŠ¡å™¨
```

## ğŸ” è®¤è¯ä¸­é—´ä»¶

```typescript
// packages/server/src/middleware/auth.ts
export const authMiddleware = async (c: Context, next: Next) => {
  if (!AUTH_ENABLED) return next();
  
  const sessionId = getCookie(c, 'session_id');
  const session = sessions.get(sessionId);
  
  if (!session || isExpired(session)) {
    return c.json({ error: 'Unauthorized' }, 401);
  }
  
  return next();
};
```

## ğŸ­ æ„å»ºæµç¨‹

### å¼€å‘æ¨¡å¼

```bash
bun run dev
  â†“
å¹¶è¡Œå¯åŠ¨ï¼š
  - packages/server (API Server) â†’ :3001
  - packages/web (Vite Dev Server) â†’ :5174
```

### ç”Ÿäº§æ„å»º

```bash
bun run build:full
  â†“
1. packages/shared â†’ dist/
2. packages/core â†’ dist/
3. packages/web â†’ dist/ (Vite build)
4. packages/server â†’ dist/
5. å¤åˆ¶ web/dist â†’ server/public/
```

### Docker æ„å»º

```dockerfile
# Stage 1: Builder
FROM oven/bun:1.3-alpine AS builder
WORKDIR /app
COPY . .
RUN bun install --frozen-lockfile
RUN bun run build:full

# Stage 2: Production
FROM node:24-alpine
COPY --from=builder /app/packages/server/dist /app/
COPY --from=builder /app/packages/server/public /app/public/
CMD ["node", "index.js"]
```

## ğŸ“Š é…ç½®ç®¡ç†

### é…ç½®æ–‡ä»¶å±‚çº§

1. **web-config.json** - ç”¨æˆ·é…ç½®ï¼ˆæœåŠ¡åˆ—è¡¨ã€å°æ™ºè¿æ¥ï¼‰
2. **runtime-state.json** - è¿è¡Œæ—¶çŠ¶æ€ï¼ˆæœåŠ¡çŠ¶æ€ã€æ—¥å¿—ï¼‰
3. **ç¯å¢ƒå˜é‡** - æ•æ„Ÿä¿¡æ¯ï¼ˆè®¤è¯ã€tokenï¼‰

### é…ç½®çƒ­é‡è½½

```typescript
// packages/core/src/config/config-loader.ts
export class ConfigLoader {
  private watcher: FSWatcher;
  
  watch() {
    this.watcher = fs.watch(CONFIG_PATH, () => {
      this.reload();
      this.emit('config:changed');
    });
  }
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```bash
bun test
```

- é€‚é…å™¨æµ‹è¯•ï¼š`tests/unit/adapters/`
- å·¥å…·è·¯ç”±æµ‹è¯•ï¼š`tests/unit/core/`
- é…ç½®åŠ è½½æµ‹è¯•ï¼š`tests/unit/config/`

### é›†æˆæµ‹è¯•

```bash
bun test:integration
```

- ç«¯åˆ°ç«¯æœåŠ¡è°ƒç”¨
- å°æ™º API é›†æˆ
- Docker å®¹å™¨æµ‹è¯•

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. é€‚é…å™¨å¤ç”¨

- Embedded é€‚é…å™¨ç›´æ¥è°ƒç”¨ï¼Œæ—  IPC å¼€é”€
- stdio é€‚é…å™¨ä½¿ç”¨è¿æ¥æ± ï¼Œå‡å°‘è¿›ç¨‹åˆ›å»º

### 2. å·¥å…·åˆ—è¡¨ç¼“å­˜

```typescript
private toolsCache = new Map<string, Tool[]>();
private cacheTTL = 60000; // 60 seconds
```

### 3. æ—¥å¿—åˆ†çº§

- å¼€å‘ç¯å¢ƒï¼šè¯¦ç»†æ—¥å¿—
- ç”Ÿäº§ç¯å¢ƒï¼šåªè®°å½• error/warn

## ğŸ“ˆ å¯æ‰©å±•æ€§

### æ·»åŠ æ–°é€‚é…å™¨

1. åˆ›å»º `packages/core/src/adapters/my-adapter.ts`
2. å®ç° `BaseAdapter` æ¥å£
3. æ³¨å†Œåˆ° `AdapterFactory`

### æ·»åŠ æ–° API è·¯ç”±

1. åˆ›å»º `packages/server/src/routes/my-route.ts`
2. å¯¼å‡º Hono app
3. åœ¨ `index.ts` ä¸­æŒ‚è½½

## ğŸ”§ å¼€å‘å·¥å…·

- **Bun**: å¿«é€Ÿçš„ JS/TS è¿è¡Œæ—¶å’ŒåŒ…ç®¡ç†å™¨
- **TypeScript**: ç±»å‹å®‰å…¨
- **ESLint + Prettier**: ä»£ç è§„èŒƒ
- **Husky**: Git hooksï¼ˆæäº¤å‰æ£€æŸ¥ï¼‰

## ğŸ“š å‚è€ƒèµ„æº

- [MCP åè®®è§„èŒƒ](https://modelcontextprotocol.io/)
- [Hono æ–‡æ¡£](https://hono.dev/)
- [Bun æ–‡æ¡£](https://bun.sh/docs)
- [React Query](https://tanstack.com/query/)

---

**è´¡çŒ®ä»£ç å‰è¯·å…ˆé˜…è¯»æœ¬æ–‡æ¡£**ï¼Œäº†è§£é¡¹ç›®æ¶æ„å’Œå¼€å‘è§„èŒƒã€‚
